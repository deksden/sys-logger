# (docs/logger/SYS_LOGGER.md, v0.6.0) SYS_LOGGER: "System Logger Subsystem" Подсистема логирования

Подсистема предоставляет единый механизм логирования для всей системы на основе pino с поддержкой уровней логирования, фильтрации по namespace, форматирования и ротации файлов. Основные возможности:

- Централизованное логирование через единый pino логгер
- Уровни логирования от trace до fatal
- Фильтрация сообщений по namespace через DEBUG
- Цветной вывод в консоль и запись в файлы
- Форматирование логов через pino-pretty
- Автоматическая ротация и архивирование
- Структурированные ошибки через SYS_ERRORS

Подсистема тесно интегрируется с:
- SYS_ERRORS для централизованной обработки ошибок
- Используется всеми другими подсистемами для логирования

## Концептуальная модель

### 1. Основные абстракции

#### Логгер (Logger)
- Центральная абстракция подсистемы
- Создается для конкретного модуля/компонента
- Может иметь namespace для фильтрации
- Предоставляет методы для разных уровней логирования
- Поддерживает структурированное логирование
- Обеспечивает единый интерфейс для всей системы

#### Транспорт (Transport)
- Определяет куда и как записываются логи
- Поддерживает множественные целевые потоки
- Управляет форматированием вывода
- Обеспечивает ротацию файлов
- Контролирует синхронность записи

#### Уровни логирования (Log Levels)
- Иерархическая система важности сообщений
- От самого подробного (trace) до критического (fatal)
- Позволяет фильтровать вывод по важности
- Определяет формат и цвет сообщений
- Влияет на место записи лога

### 2. Принципы работы

#### Единая точка логирования
- Все логи проходят через центральный логгер
- Гарантируется единый формат и обработка
- Централизованное управление конфигурацией
- Общие правила фильтрации и форматирования

#### Namespace-based фильтрация
- Каждый логгер имеет свой namespace
- Фильтрация через переменную DEBUG
- Поддержка wildcard и negation паттернов
- Иерархическая структура namespace
- Возможность точечного включения/выключения

#### Структурированное логирование
- Логи хранят контекст в виде объектов
- Поддержка метаданных и меток
- Автоматическая сериализация данных
- Специальная обработка ошибок
- Форматированный вывод в консоль

#### Отказоустойчивость
- Fallback на консольный вывод при проблемах с файлами
- Автоматическое восстановление после ошибок
- Защита от потери данных при ротации
- Безопасное форматирование сообщений
- Обработка ошибок через SYS_ERRORS

### 3. Паттерны использования

#### Создание логгера
- Один логгер на модуль/компонент
- Namespace отражает иерархию системы
- Переиспользование базового логгера
- Создание дочерних логгеров с доп. контекстом

#### Уровни логирования
- trace: входные параметры и детали выполнения
- debug: результаты операций и состояния
- info: важные бизнес-события
- warn: некритичные проблемы и предупреждения
- error: ошибки выполнения операций
- fatal: критические системные ошибки

#### Структурированный контекст
- Группировка связанной информации
- Стандартные поля для типовых данных
- Специальная обработка ошибок
- Добавление меток и метаданных

#### Управление выводом
- Фильтрация через DEBUG
- Настройка через переменные окружения
- Конфигурация форматирования
- Управление ротацией файлов

## Структура 

### Подсистемы

Вложенных подсистем нет.

### Список файлов

```
src/logger/
 ├── logger.js         # Основной модуль, API подсистемы
 ├── format.js         # Функции форматирования логов  
 ├── rotate.js         # Управление ротацией файлов
 └── config.js         # Загрузка и валидация конфигурации
```

## Общий типовой интерфейс

### Dependency Injection

Все модули подсистемы поддерживают единый интерфейс dependency injection:

```javascript
/**
 * Зависимости модуля
 * @type {Object}
 */
export const dependencies;

/**
 * Устанавливает зависимости модуля
 * @param {Partial<typeof dependencies>} newDependencies - Новые зависимости
 */
export function setDependencies(newDependencies);
```

### Централизованная обработка ошибок (SYS_ERRORS), коды ошибок:

```javascript
LOGGER_ERROR_CODES:

  // Ошибки конфигурации
  CONFIG_LOAD_FAILED: Ошибка загрузки конфигурации логгера
    - context:
      - reason: причина ошибки

  INVALID_LOG_LEVEL: Некорректный уровень логирования
    - context:
      - level: некорректный уровень

  // Ошибки файловой системы  
  LOG_DIR_CREATE_FAILED: Ошибка создания директории логов
    - context:
      - path: путь к директории
      - reason: причина ошибки

  LOG_FILE_WRITE_FAILED: Ошибка записи в файл лога
    - context:
      - path: путь к файлу
      - reason: причина ошибки

  // Ошибки ротации логов
  ROTATE_FAILED: Ошибка ротации лог файла
    - context:
      - path: путь к файлу
      - reason: причина ошибки

  CLEANUP_FAILED: Ошибка очистки старых архивов
    - context:
      - reason: причина ошибки

  // Ошибки форматирования
  FORMAT_FAILED: Ошибка форматирования сообщения
    - context:
      - reason: причина ошибки

  // Ошибки транспорта
  TRANSPORT_INIT_FAILED: Ошибка инициализации транспорта
    - context:
      - reason: причина ошибки
```

### Логирование (SYS_LOGGER), определены namespace:

```javascript
(config.js) "logger:config" Конфигурация логгера
(format.js) "logger:format" Форматирование логов
(logger.js) "logger" Основной модуль логирования
(rotate.js) "logger:rotate" Ротация лог файлов
```

## (src/logger/config.js) Модуль - Загрузка и валидация конфигурации логгера

### Описание модуля

Модуль отвечает за загрузку настроек логгера и создание конфигурации pino. Поддерживает настройку уровней логирования, цветного вывода, файловых и консольных транспортов через переменные окружения. Обеспечивает валидацию настроек и применение значений по умолчанию.

### Зависимости модуля

Внешние зависимости:
- pino (v5.17.0) - основной движок логирования  
- pino-pretty - форматирование вывода для консоли

Внутренние зависимости:
- ../../logger/logger.js - базовый логгер
- ../schema/validator.js - валидация конфигурации
- ./error-fabs-logger.js - фабрики ошибок логгера

Импортированные модули подсистемы:
- нет

Используемые переменные окружения:
- LOG_LEVEL - уровень логирования (trace, debug, info, warn, error, fatal)
- LOG_COLORIZE - цветной вывод в консоль (true/false)
- LOG_FILE_OUTPUT - запись в файл (true/false)
- LOG_CONSOLE_OUTPUT - вывод в консоль (true/false)
- LOG_FOLDER - папка для лог файлов
- LOG_SYNC - синхронная запись (true/false)
- LOG_PRETTY - форматированный вывод (true/false)

### Сущности кода

Поддерживает общий интерфейс dependency injection: dependencies, setDependencies

```javascript
/**
 * loadConfig: Загружает конфигурацию логгера из переменных окружения
 * 
 * Описание:
 * Загружает и валидирует настройки логгера из переменных окружения.
 * Применяет значения по умолчанию для отсутствующих параметров.
 * 
 * Ожидаемое поведение:
 * - Загружает настройки из env переменных
 * - Применяет дефолтные значения при отсутствии
 * - Нормализует значения true/false
 * - Возвращает объект конфигурации
 * 
 * @param {Object} env - Переменные окружения
 * @returns {Object} Конфигурация с настройками транспортов и форматирования
 */
export function loadConfig(env)

/**
 * createTransport: Создает конфигурацию транспорта для pino
 * 
 * Описание:
 * Создает и настраивает транспорты для записи логов на основе конфигурации.
 * Поддерживает множественные транспорты - файловый и консольный.
 * Управляет форматированием через pino-pretty.
 * 
 * Ожидаемое поведение:
 * - Создает указанные в конфигурации транспорты
 * - Настраивает форматирование для консоли
 * - При отсутствии директории создает её
 * - Применяет настройки цветов и синхронности
 * - По умолчанию использует stdout через pretty
 * - При ошибках инициализации выбрасывает исключения
 * 
 * @param {Object} env - Переменные окружения
 * @returns {Object} Конфигурация транспорта для pino
 * @throws {SystemError} LOG_DIR_CREATE_FAILED при ошибке создания директории
 * @throws {SystemError} TRANSPORT_INIT_FAILED при ошибке инициализации
 */
export function createTransport(env)

/** 
 * @typedef {Object} LoggerConfig
 * @property {string} logLevel - Уровень логирования
 * @property {boolean} colorize - Использовать цвета
 * @property {boolean} fileOutput - Запись в файл
 * @property {boolean} consoleOutput - Вывод в консоль
 * @property {string} logFolder - Папка для логов
 * @property {boolean} sync - Синхронная запись
 * @property {boolean} pretty - Форматированный вывод
 */
```

## (src/logger/format.js) Модуль - Форматирование логов с поддержкой цветного вывода и различных форматов данных

### Описание модуля

Модуль предоставляет функции для форматирования различных типов данных при логировании. Обеспечивает корректное преобразование специальных типов (Error, Date, RegExp), поддержку цветного вывода, форматирование временных меток и специальную обработку системных ошибок.

### Зависимости модуля

Внешние зависимости:
- chalk - поддержка цветного вывода в консоль

Внутренние зависимости:
- ../../logger/logger.js - базовый логгер
- ../errors/errors.js - работа с ошибками
- ./error-fabs-logger.js - фабрики ошибок логгера

Импортированные модули подсистемы:
- createLogger - создание логгера для внутреннего использования

Используемые переменные окружения:
- нет

### Сущности кода

Поддерживает общий интерфейс dependency injection: dependencies, setDependencies

```javascript
/**
 * formatForLog: Форматирует объект для логирования
 * 
 * Описание:
 * Преобразует различные типы данных в строковое представление для логирования.
 * Обеспечивает специальную обработку ошибок, дат, регулярных выражений.
 * Поддерживает цветной вывод и структурированное форматирование.
 * 
 * Ожидаемое поведение:
 * - Преобразует примитивы в строки
 * - Форматирует SystemError с кодом и стеком
 * - Форматирует обычные Error с именем и стеком
 * - Конвертирует Date в ISO формат
 * - Преобразует RegExp в строку
 * - Обрабатывает Map и Set
 * - Применяет цветовое оформление
 * - При ошибках форматирования выбрасывает исключение
 * 
 * @param {any} obj - Объект для логирования
 * @param {Object} [options] - Опции форматирования
 * @param {boolean} [options.colors=true] - Использовать цвета
 * @param {boolean} [options.showHidden=false] - Показывать скрытые свойства
 * @returns {string} Отформатированная строка для вывода в лог
 * @throws {SystemError} FORMAT_FAILED при ошибке форматирования
 */
export function formatForLog(obj, options = {})

/**
 * formatTimestamp: Форматирует метку времени
 * 
 * Описание:
 * Преобразует дату в требуемый формат с опциональным цветовым оформлением.
 * Поддерживает различные форматы вывода даты.
 * 
 * Ожидаемое поведение:
 * - Преобразует дату в указанный формат
 * - Добавляет цветовое оформление при необходимости
 * - Поддерживает ISO, UTC и локальные форматы
 * - По умолчанию использует ISO формат
 * 
 * @param {Date} [date=new Date()] - Дата для форматирования
 * @param {Object} [options] - Опции форматирования
 * @param {boolean} [options.colors=true] - Использовать цвета
 * @param {string} [options.format='ISO'] - Формат (ISO, UTC, local)
 * @returns {string} Отформатированная метка времени
 */
export function formatTimestamp(date = new Date(), options = {})

/**
 * formatError: Форматирует сообщение об ошибке
 * 
 * Описание:
 * Форматирует информацию об ошибке с опциональным включением стека вызовов.
 * Специальная обработка для SystemError и стандартных Error.
 * 
 * Ожидаемое поведение:
 * - Для SystemError включает код и name
 * - Для обычных Error использует name
 * - Опционально включает стек вызовов
 * - Применяет цветовое оформление
 * - Форматирует многострочный вывод
 * 
 * @param {Error} error - Объект ошибки
 * @param {Object} [options] - Опции форматирования
 * @param {boolean} [options.colors=true] - Использовать цвета
 * @param {boolean} [options.stack=true] - Включать стек вызовов
 * @returns {string} Отформатированное сообщение об ошибке
 */
export function formatError(error, options = {})
```

## (src/logger/logger.js) Модуль - Основной модуль логирования с поддержкой уровней и фильтрации

### Описание модуля

Основной модуль подсистемы логирования, предоставляющий API для создания логгеров с фильтрацией по namespace. Обеспечивает различные уровни логирования, поддержку структурированных данных, обработку ошибок и управление выводом через механизм DEBUG.

### Зависимости модуля

Внешние зависимости:
- pino - базовый движок логирования

Внутренние зависимости:
- ./config.js - конфигурация логгера
- ./error-fabs-logger.js - фабрики ошибок

Импортированные модули подсистемы:
- createTransport из config.js

Используемые переменные окружения:
- DEBUG - паттерны фильтрации namespace
- LOG_LEVEL - базовый уровень логирования

### Сущности кода

Поддерживает общий интерфейс dependency injection: dependencies, setDependencies

```javascript
/**
 * createLogger: Создает логгер с фильтрацией по namespace
 * 
 * Описание:
 * Создает и настраивает экземпляр логгера с поддержкой фильтрации по namespace
 * через механизм DEBUG. Обеспечивает единую точку создания логгеров в системе.
 * 
 * Ожидаемое поведение:
 * - Создает/переиспользует базовый pino логгер
 * - Добавляет namespace в метаданные если указан
 * - Применяет фильтрацию по DEBUG
 * - Поддерживает все методы pino
 * - Специальная обработка ошибок
 * - Форматирование через плейсхолдеры
 * 
 * @param {string} [namespace] - Namespace для фильтрации
 * @returns {Object} Объект с методами логирования
 * @throws {SystemError} TRANSPORT_INIT_FAILED при ошибке инициализации
 */
export function createLogger(namespace = undefined)

/**
 * @type {string[]}
 * Поддерживаемые уровни логирования
 */
export const LOG_LEVELS = ['trace', 'debug', 'info', 'warn', 'error', 'fatal']
```

## (src/logger/rotate.js) Модуль - Управление ротацией и архивированием лог файлов

### Описание модуля

Модуль обеспечивает ротацию лог файлов при достижении максимального размера и управляет архивными копиями. Поддерживает сжатие архивов, очистку старых файлов и безопасное переключение между файлами.

### Зависимости модуля

Внутренние зависимости:
- ../../logger/logger.js - базовый логгер
- ./error-fabs-logger.js - фабрики ошибок

Импортированные модули подсистемы:
- createLogger - создание логгера для внутреннего использования

Используемые переменные окружения:
- LOG_MAX_SIZE - максимальный размер файла для ротации
- LOG_MAX_FILES - максимальное количество архивных файлов

### Сущности кода

Поддерживает общий интерфейс dependency injection: dependencies, setDependencies

```javascript
/** 
 * @typedef {Object} RotateConfig
 * @property {string} logFolder - Папка для логов
 * @property {number} maxSize - Максимальный размер файла в байтах
 * @property {number} maxFiles - Максимальное количество архивных файлов
 * @property {boolean} compress - Сжимать архивные файлы
 */

/**
 * checkAndRotate: Проверяет необходимость ротации и выполняет её
 * 
 * Описание:
 * Проверяет размер лог файла и при превышении лимита выполняет ротацию.
 * Создает архивную копию с меткой времени, очищает старые архивы.
 * 
 * Ожидаемое поведение:
 * - Проверяет существование и размер файла
 * - При превышении создает архив с timestamp
 * - Опционально сжимает архив
 * - Очищает старые архивы
 * - Создает новый пустой файл
 * 
 * @param {string} filePath - Путь к файлу лога
 * @param {RotateConfig} config - Конфигурация ротации
 * @returns {Promise<boolean>} true если была выполнена ротация
 * @throws {SystemError} ROTATE_FAILED при ошибке ротации
 */
export async function checkAndRotate(filePath, config)

/**
 * cleanupOldArchives: Очищает старые архивные файлы
 * 
 * Описание:
 * Находит и удаляет архивные файлы сверх установленного лимита.
 * Сортирует архивы по дате создания для удаления самых старых.
 * 
 * Ожидаемое поведение:
 * - Сканирует папку на наличие архивов
 * - Сортирует по дате создания
 * - Удаляет архивы сверх лимита
 * - Возвращает список удаленных файлов
 * 
 * @param {string} logFolder - Папка с логами
 * @param {RotateConfig} config - Конфигурация ротации
 * @returns {Promise<string[]>} Пути удаленных файлов
 * @throws {SystemError} CLEANUP_FAILED при ошибке очистки
 */
export async function cleanupOldArchives(logFolder, config)

/**
 * archiveTestLogs: Архивирует тестовые логи
 * 
 * Описание:
 * Добавляет текущие тестовые логи в архивный файл с меткой времени.
 * Контролирует размер архива и выполняет ротацию при необходимости.
 * 
 * Ожидаемое поведение:
 * - Проверяет наличие тестовых логов
 * - Добавляет в архив с разделителем и timestamp
 * - При превышении размера выполняет ротацию
 * - Очищает исходный файл после архивации
 * 
 * @param {string} testFile - Путь к файлу текущих тестовых логов
 * @param {string} archiveFile - Путь к архивному файлу 
 * @returns {Promise<void>}
 * @throws {SystemError} ROTATE_FAILED при ошибке ротации
 */
export async function archiveTestLogs(testFile, archiveFile)
```


