# (docs/logger/SYS_LOGGER.md, v0.8.4) SYS_LOGGER: "System Logger Subsystem" Подсистема логирования

Подсистема предоставляет единый механизм логирования для всей системы на основе pino с поддержкой уровней логирования, фильтрации по namespace, форматирования и ротации файлов. Основные возможности:

- Централизованное логирование через единый интерфейс (`createLogger`)
- Уровни логирования от trace до fatal
- Фильтрация сообщений по namespace через `DEBUG` (логика модуля `debug`)
- Цветной вывод в консоль и запись в файлы
- Форматирование логов через pino-pretty
- Автоматическая ротация и архивирование
- Структурированные ошибки через SYS_ERRORS
- **Расширенный API логгера:** Возвращаемый объект включает `.child()`, `.level`, `.bindings()` и др.

Подсистема тесно интегрируется с:
- SYS_ERRORS для централизованной обработки ошибок
- Используется всеми другими подсистемами для логирования

## Концептуальная модель

### 1. Основные абстракции

#### Логгер (Logger)
- Центральная абстракция подсистемы, создаваемая `createLogger(namespace?)`.
- Может иметь `namespace` для фильтрации (`DEBUG`).
- Предоставляет методы для разных уровней логирования (`info`, `debug`...).
- Поддерживает структурированное логирование (передача объекта первым аргументом).
- **Предоставляет методы `.child()`, `.bindings()`, свойство `.level` и др. для управления и добавления контекста.**
- Обеспечивает единый интерфейс для всей системы.

#### Транспорт (Transport)
- Определяет куда и как записываются логи (консоль, файл).
- Поддерживает множественные целевые потоки (`TRANSPORT{N}`).
- Управляет форматированием вывода через pino-pretty (для консоли).
- Обеспечивает ротацию файлов (для файлового транспорта).
- Контролирует синхронность записи.

#### Уровни логирования (Log Levels)
- Иерархическая система важности сообщений (`trace` < `debug` < `info` < `warn` < `error` < `fatal`).
- Позволяет фильтровать вывод по важности (`LOG_LEVEL`, `TRANSPORT{N}_LEVEL`, `logger.level`).
- Определяет формат и цвет сообщений через pino-pretty.

### 2. Принципы работы

#### Единая точка входа
- Логирование инициируется через `createLogger`.
- Единый базовый экземпляр `pino` для всей системы.
- Централизованное управление конфигурацией транспортов.
- Общие правила фильтрации (`DEBUG`, уровни) и обработки (Map, строки).

#### Namespace-based фильтрация
- Каждый логгер может иметь свой `namespace`.
- Фильтрация через переменную `DEBUG` (логика модуля `debug`).
- Поддержка wildcard (`*`) и negation (`-`) паттернов.
- Иерархическая структура namespace (`app:module:sub`).
- Возможность точечного включения/выключения модулей.

#### Структурированное логирование
- Логи хранят контекст в виде объектов.
- Поддержка метаданных (`bindings`, добавленные через `.child()`).
- Автоматическая сериализация данных через `pino`.
- Специальная обработка ошибок (`err` поле).
- Форматированный вывод в консоль через `pino-pretty`.

#### Отказоустойчивость
- Fallback на консольный вывод при проблемах с файлами (через конфигурацию `pino`).
- Безопасное форматирование сообщений.
- Обработка ошибок конфигурации и записи через `SYS_ERRORS`.

### 3. Паттерны использования

#### Создание логгера
- Один логгер на модуль/компонент (`createLogger('my-module')`).
- Namespace отражает иерархию системы (`app:service:db`).
- Использование `logger.child()` для добавления контекста (ID запроса, ID пользователя) к группе логов.
  ```javascript
  const serviceLogger = createLogger('service');
  function handleRequest(req) {
    const reqLogger = serviceLogger.child({ requestId: req.id });
    reqLogger.info('Handling request');
    // ...
    reqLogger.debug('Request finished');
  }
  ```

#### Уровни логирования
- `trace`: Детали алгоритмов, вход/выход функций.
- `debug`: Отладочная информация, промежуточные результаты.
- `info`: Ключевые события приложения, старт/стоп сервисов.
- `warn`: Потенциальные проблемы, нештатные, но ожидаемые ситуации.
- `error`: Ошибки выполнения операций, которые не остановили приложение.
- `fatal`: Критические ошибки, требующие немедленного вмешательства или приводящие к остановке.
- Использование `logger.level` для временного повышения детализации модуля.

#### Структурированный контекст
- Передача объекта первым аргументом (`logger.info({ userId }, 'message')`).
- Использование стандартных полей (`err` для ошибок).
- Добавление контекста через `logger.child()`.

#### Управление выводом
- Фильтрация через `DEBUG`.
- Настройка уровней через переменные окружения и `logger.level`.
- Конфигурация транспортов через `TRANSPORT{N}`.

## Структура

### Подсистемы

Вложенных подсистем нет.

### Список файлов

```
src/logger/
 ├── logger.js         # Основной модуль, API (`createLogger`)
 ├── config.js         # Загрузка и валидация конфигурации, создание транспортов
 ├── errors-logger.js  # Определения кодов ошибок
 ├── error-fabs-logger.js # Фабрики ошибок
 └── rotate.js         # Управление ротацией файлов (используется внутри config.js)
```

## Общий типовой интерфейс

### Dependency Injection

Все модули подсистемы (`logger.js`, `config.js`, `rotate.js`, `error-fabs-logger.js`) поддерживают единый интерфейс dependency injection:

```javascript
export const dependencies;
export function setDependencies(newDependencies);
```

### Централизованная обработка ошибок (SYS_ERRORS), коды ошибок:

(Определения кодов ошибок `LOGGER_ERROR_CODES` остаются без изменений, см. `errors-logger.js`)

### Логирование (SYS_LOGGER), определены namespace:

(Неймспейсы для внутреннего логирования подсистемы остаются без изменений)

```javascript
(config.js) "logger:config" Конфигурация логгера
(logger.js) "logger" Основной модуль логирования
(rotate.js) "logger:rotate" Ротация лог файлов
```
